{
	"info": {
		"_postman_id": "cart-order-payment-flow-2024",
		"name": "Cart, Order & Payment Flow",
		"description": "Complete Postman collection for testing the cart, checkout, order, and payment flow. Includes all endpoints with proper authentication and variable management.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "1. Authentication",
			"item": [
				{
					"name": "Login (Buyer)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const response = pm.response.json();",
									"    if (response.token) {",
									"        pm.environment.set('auth_token', response.token);",
									"        pm.environment.set('user_id', response.user.id);",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"email\": \"buyer@example.com\",\n    \"password\": \"password123\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/users/login",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "users", "login"]
						},
						"description": "Login as a buyer user. Token will be saved to environment variable."
					},
					"response": []
				}
			],
			"description": "Authentication endpoints to get access token"
		},
		{
			"name": "2. Cart Operations",
			"item": [
				{
					"name": "Get Cart",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/v1/cart",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "cart"]
						},
						"description": "Get current user's cart with all items"
					},
					"response": []
				},
				{
					"name": "Add Item to Cart",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 201) {",
									"    const response = pm.response.json();",
									"    pm.environment.set('cart_item_id', response.id);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"product_id\": \"{{product_id}}\",\n    \"quantity\": 2,\n    \"variant_id\": null\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/cart/add",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "cart", "add"]
						},
						"description": "Add a product to cart. Set variant_id to null for products without variants."
					},
					"response": []
				},
				{
					"name": "Update Cart Item Quantity",
					"request": {
						"method": "PUT",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"quantity\": 3\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/cart/items/{{cart_item_id}}",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "cart", "items", "{{cart_item_id}}"]
						},
						"description": "Update cart item quantity. Set to 0 to remove."
					},
					"response": []
				},
				{
					"name": "Remove Item from Cart",
					"request": {
						"method": "DELETE",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/v1/cart/items/{{cart_item_id}}",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "cart", "items", "{{cart_item_id}}"]
						},
						"description": "Remove an item from cart"
					},
					"response": []
				},
				{
					"name": "Get Cart Summary",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/v1/cart/summary",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "cart", "summary"]
						},
						"description": "Get lightweight cart summary for header/mini-cart display"
					},
					"response": []
				},
				{
					"name": "Clear Cart",
					"request": {
						"method": "DELETE",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/v1/cart",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "cart"]
						},
						"description": "Clear all items from cart"
					},
					"response": []
				}
			],
			"description": "Cart management endpoints"
		},
		{
			"name": "3. Checkout & Order Creation",
			"item": [
				{
					"name": "Checkout Cart (Create Order)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 201) {",
									"    const response = pm.response.json();",
									"    pm.environment.set('order_id', response.order_id);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"shipping_address\": {\n        \"street\": \"123 Main St\",\n        \"city\": \"Lagos\",\n        \"state\": \"Lagos\",\n        \"country\": \"Nigeria\",\n        \"postal_code\": \"100001\",\n        \"phone\": \"+2348012345678\"\n    },\n    \"billing_address\": {\n        \"street\": \"123 Main St\",\n        \"city\": \"Lagos\",\n        \"state\": \"Lagos\",\n        \"country\": \"Nigeria\",\n        \"postal_code\": \"100001\"\n    },\n    \"notes\": \"Please leave at door\",\n    \"idempotency_key\": \"{{$randomUUID}}\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/cart/checkout",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "cart", "checkout"]
						},
						"description": "Convert cart to order. Creates order with status 'pending_payment'. All totals are calculated (subtotal, shipping, tax, discount, total)."
					},
					"response": []
				},
				{
					"name": "Get Order Details",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/v1/orders/{{order_id}}",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "orders", "{{order_id}}"]
						},
						"description": "Get detailed order information including payment status"
					},
					"response": []
				},
				{
					"name": "List User Orders",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/v1/orders",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "orders"]
						},
						"description": "Get all orders for the current buyer"
					},
					"response": []
				}
			],
			"description": "Checkout and order management endpoints"
		},
		{
			"name": "4. Payment Operations",
			"item": [
				{
					"name": "Create Payment",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 201) {",
									"    const response = pm.response.json();",
									"    pm.environment.set('payment_id', response.id);",
									"    if (response.gateway_response && response.gateway_response.data) {",
									"        pm.environment.set('paystack_reference', response.gateway_response.data.reference);",
									"        pm.environment.set('authorization_url', response.gateway_response.data.authorization_url);",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"order_id\": \"{{order_id}}\",\n    \"amount\": 105.37,\n    \"currency\": \"NGN\",\n    \"method\": \"card\",\n    \"metadata\": {},\n    \"idempotency_key\": \"{{$randomUUID}}\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/payments/create",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "payments", "create"]
						},
						"description": "Create a payment record for an order. For card payments, returns Paystack authorization URL."
					},
					"response": []
				},
				{
					"name": "Initialize Payment (Paystack)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const response = pm.response.json();",
									"    pm.environment.set('payment_id', response.payment_id);",
									"    pm.environment.set('authorization_url', response.authorization_url);",
									"    pm.environment.set('paystack_reference', response.reference);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"order_id\": \"{{order_id}}\",\n    \"amount\": 105.37,\n    \"currency\": \"NGN\",\n    \"method\": \"card\",\n    \"idempotency_key\": \"{{$randomUUID}}\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/payments/initialize",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "payments", "initialize"]
						},
						"description": "Initialize Paystack payment and get authorization URL. Convenience endpoint that creates payment and returns Paystack data."
					},
					"response": []
				},
				{
					"name": "Get Payment Details",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/v1/payments/{{payment_id}}",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "payments", "{{payment_id}}"]
						},
						"description": "Get payment information"
					},
					"response": []
				},
				{
					"name": "Verify Payment",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/v1/payments/{{payment_id}}/verify",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "payments", "{{payment_id}}", "verify"]
						},
						"description": "Verify payment status with Paystack. Use this for polling after redirect."
					},
					"response": []
				},
				{
					"name": "Process Payment (Bank Transfer)",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"bank\": {\n        \"code\": \"057\",\n        \"account_number\": \"0000000000\"\n    },\n    \"metadata\": {}\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/payments/{{payment_id}}/process",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "payments", "{{payment_id}}", "process"]
						},
						"description": "Process bank transfer payment. Requires payment to be created first with method='bank_transfer'."
					},
					"response": []
				},
				{
					"name": "List User Payments",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/v1/payments?page=1&per_page=20",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "payments"],
							"query": [
								{
									"key": "page",
									"value": "1"
								},
								{
									"key": "per_page",
									"value": "20"
								}
							]
						},
						"description": "Get paginated list of user's payments"
					},
					"response": []
				}
			],
			"description": "Payment processing endpoints"
		},
		{
			"name": "5. Complete Flow Tests",
			"item": [
				{
					"name": "Full Flow: Cart to Payment",
					"item": [
						{
							"name": "Step 1: Add Items to Cart",
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Authorization",
										"value": "Bearer {{auth_token}}"
									},
									{
										"key": "Content-Type",
										"value": "application/json"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\n    \"product_id\": \"{{product_id}}\",\n    \"quantity\": 2,\n    \"variant_id\": null\n}"
								},
								"url": {
									"raw": "{{base_url}}/api/v1/cart/add",
									"host": ["{{base_url}}"],
									"path": ["api", "v1", "cart", "add"]
								}
							},
							"response": []
						},
						{
							"name": "Step 2: Get Cart Summary",
							"request": {
								"method": "GET",
								"header": [
									{
										"key": "Authorization",
										"value": "Bearer {{auth_token}}"
									}
								],
								"url": {
									"raw": "{{base_url}}/api/v1/cart/summary",
									"host": ["{{base_url}}"],
									"path": ["api", "v1", "cart", "summary"]
								}
							},
							"response": []
						},
						{
							"name": "Step 3: Checkout (Create Order)",
							"event": [
								{
									"listen": "test",
									"script": {
										"exec": [
											"if (pm.response.code === 201) {",
											"    const response = pm.response.json();",
											"    pm.environment.set('order_id', response.order_id);",
											"}"
										],
										"type": "text/javascript"
									}
								}
							],
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Authorization",
										"value": "Bearer {{auth_token}}"
									},
									{
										"key": "Content-Type",
										"value": "application/json"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\n    \"shipping_address\": {\n        \"street\": \"123 Main St\",\n        \"city\": \"Lagos\",\n        \"state\": \"Lagos\",\n        \"country\": \"Nigeria\",\n        \"postal_code\": \"100001\",\n        \"phone\": \"+2348012345678\"\n    },\n    \"billing_address\": {\n        \"street\": \"123 Main St\",\n        \"city\": \"Lagos\",\n        \"state\": \"Lagos\",\n        \"country\": \"Nigeria\",\n        \"postal_code\": \"100001\"\n    },\n    \"notes\": \"Test order\",\n    \"idempotency_key\": \"test-flow-{{$timestamp}}\"\n}"
								},
								"url": {
									"raw": "{{base_url}}/api/v1/cart/checkout",
									"host": ["{{base_url}}"],
									"path": ["api", "v1", "cart", "checkout"]
								}
							},
							"response": []
						},
						{
							"name": "Step 4: Verify Order Created",
							"request": {
								"method": "GET",
								"header": [
									{
										"key": "Authorization",
										"value": "Bearer {{auth_token}}"
									}
								],
								"url": {
									"raw": "{{base_url}}/api/v1/orders/{{order_id}}",
									"host": ["{{base_url}}"],
									"path": ["api", "v1", "orders", "{{order_id}}"]
								}
							},
							"response": []
						},
						{
							"name": "Step 5: Initialize Payment",
							"event": [
								{
									"listen": "test",
									"script": {
										"exec": [
											"if (pm.response.code === 200) {",
											"    const response = pm.response.json();",
											"    pm.environment.set('payment_id', response.payment_id);",
											"    pm.environment.set('authorization_url', response.authorization_url);",
											"    console.log('Payment initialized. Authorization URL:', response.authorization_url);",
											"}"
										],
										"type": "text/javascript"
									}
								}
							],
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Authorization",
										"value": "Bearer {{auth_token}}"
									},
									{
										"key": "Content-Type",
										"value": "application/json"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\n    \"order_id\": \"{{order_id}}\",\n    \"amount\": 105.37,\n    \"currency\": \"NGN\",\n    \"method\": \"card\",\n    \"idempotency_key\": \"payment-{{$timestamp}}\"\n}"
								},
								"url": {
									"raw": "{{base_url}}/api/v1/payments/initialize",
									"host": ["{{base_url}}"],
									"path": ["api", "v1", "payments", "initialize"]
								}
							},
							"response": []
						},
						{
							"name": "Step 6: Verify Payment Status",
							"request": {
								"method": "GET",
								"header": [
									{
										"key": "Authorization",
										"value": "Bearer {{auth_token}}"
									}
								],
								"url": {
									"raw": "{{base_url}}/api/v1/payments/{{payment_id}}/verify",
									"host": ["{{base_url}}"],
									"path": ["api", "v1", "payments", "{{payment_id}}", "verify"]
								}
							},
							"response": []
						}
					],
					"description": "Complete end-to-end flow test from cart to payment"
				},
				{
					"name": "Test: Inventory Validation",
					"item": [
						{
							"name": "Add Out of Stock Item",
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Authorization",
										"value": "Bearer {{auth_token}}"
									},
									{
										"key": "Content-Type",
										"value": "application/json"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\n    \"product_id\": \"{{out_of_stock_product_id}}\",\n    \"quantity\": 100,\n    \"variant_id\": null\n}"
								},
								"url": {
									"raw": "{{base_url}}/api/v1/cart/add",
									"host": ["{{base_url}}"],
									"path": ["api", "v1", "cart", "add"]
								},
								"description": "Try to add an out-of-stock item. Should succeed in cart, but fail at checkout."
							},
							"response": []
						},
						{
							"name": "Try Checkout with Insufficient Stock",
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Authorization",
										"value": "Bearer {{auth_token}}"
									},
									{
										"key": "Content-Type",
										"value": "application/json"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\n    \"shipping_address\": {\n        \"street\": \"123 Main St\",\n        \"city\": \"Lagos\",\n        \"state\": \"Lagos\",\n        \"country\": \"Nigeria\",\n        \"postal_code\": \"100001\",\n        \"phone\": \"+2348012345678\"\n    },\n    \"billing_address\": {\n        \"street\": \"123 Main St\",\n        \"city\": \"Lagos\",\n        \"state\": \"Lagos\",\n        \"country\": \"Nigeria\",\n        \"postal_code\": \"100001\"\n    }\n}"
								},
								"url": {
									"raw": "{{base_url}}/api/v1/cart/checkout",
									"host": ["{{base_url}}"],
									"path": ["api", "v1", "cart", "checkout"]
								},
								"description": "Should fail with 422 error and message about insufficient stock"
							},
							"response": []
						}
					],
					"description": "Test inventory validation at checkout"
				},
				{
					"name": "Test: Idempotency",
					"item": [
						{
							"name": "Checkout with Idempotency Key (First)",
							"event": [
								{
									"listen": "test",
									"script": {
										"exec": [
											"if (pm.response.code === 201) {",
											"    const response = pm.response.json();",
											"    pm.environment.set('first_order_id', response.order_id);",
											"}"
										],
										"type": "text/javascript"
									}
								}
							],
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Authorization",
										"value": "Bearer {{auth_token}}"
									},
									{
										"key": "Content-Type",
										"value": "application/json"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\n    \"shipping_address\": {\n        \"street\": \"123 Main St\",\n        \"city\": \"Lagos\",\n        \"state\": \"Lagos\",\n        \"country\": \"Nigeria\",\n        \"postal_code\": \"100001\",\n        \"phone\": \"+2348012345678\"\n    },\n    \"billing_address\": {\n        \"street\": \"123 Main St\",\n        \"city\": \"Lagos\",\n        \"state\": \"Lagos\",\n        \"country\": \"Nigeria\",\n        \"postal_code\": \"100001\"\n    },\n    \"idempotency_key\": \"test-idempotency-12345\"\n}"
								},
								"url": {
									"raw": "{{base_url}}/api/v1/cart/checkout",
									"host": ["{{base_url}}"],
									"path": ["api", "v1", "cart", "checkout"]
								},
								"description": "First checkout with idempotency key"
							},
							"response": []
						},
						{
							"name": "Checkout with Same Idempotency Key (Retry)",
							"event": [
								{
									"listen": "test",
									"script": {
										"exec": [
											"if (pm.response.code === 201) {",
											"    const response = pm.response.json();",
											"    const firstOrderId = pm.environment.get('first_order_id');",
											"    if (response.order_id === firstOrderId) {",
											"        console.log('✅ Idempotency works! Same order returned.');",
											"    } else {",
											"        console.log('❌ Idempotency failed! Different order created.');",
											"    }",
											"}"
										],
										"type": "text/javascript"
									}
								}
							],
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Authorization",
										"value": "Bearer {{auth_token}}"
									},
									{
										"key": "Content-Type",
										"value": "application/json"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\n    \"shipping_address\": {\n        \"street\": \"123 Main St\",\n        \"city\": \"Lagos\",\n        \"state\": \"Lagos\",\n        \"country\": \"Nigeria\",\n        \"postal_code\": \"100001\",\n        \"phone\": \"+2348012345678\"\n    },\n    \"billing_address\": {\n        \"street\": \"123 Main St\",\n        \"city\": \"Lagos\",\n        \"state\": \"Lagos\",\n        \"country\": \"Nigeria\",\n        \"postal_code\": \"100001\"\n    },\n    \"idempotency_key\": \"test-idempotency-12345\"\n}"
								},
								"url": {
									"raw": "{{base_url}}/api/v1/cart/checkout",
									"host": ["{{base_url}}"],
									"path": ["api", "v1", "cart", "checkout"]
								},
								"description": "Retry checkout with same idempotency key. Should return same order (409 or 201 with same order_id)."
							},
							"response": []
						}
					],
					"description": "Test idempotency protection for order creation"
				}
			],
			"description": "Complete flow tests and edge cases"
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	],
	"variable": [
		{
			"key": "base_url",
			"value": "http://localhost:8000",
			"type": "string"
		},
		{
			"key": "auth_token",
			"value": "",
			"type": "string"
		},
		{
			"key": "user_id",
			"value": "",
			"type": "string"
		},
		{
			"key": "product_id",
			"value": "PRD_ABC123",
			"type": "string",
			"description": "Replace with actual product ID from your database"
		},
		{
			"key": "order_id",
			"value": "",
			"type": "string"
		},
		{
			"key": "payment_id",
			"value": "",
			"type": "string"
		},
		{
			"key": "cart_item_id",
			"value": "",
			"type": "string"
		},
		{
			"key": "paystack_reference",
			"value": "",
			"type": "string"
		},
		{
			"key": "authorization_url",
			"value": "",
			"type": "string"
		}
	]
}




